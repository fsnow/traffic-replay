# Traffic Recordings

This directory contains traffic recordings and test scripts for the traffic-replay project.

## Files

### `recording1.txt`
Original recording from initial testing (2.2 MiB, 5,041 packets).
- Created: 2025-11-04
- Contains: 29 user operations + 5,012 internal operations (hello, getMore on oplog, etc.)
- Purpose: Initial validation and testing

### `expected-operations.js`
Mongosh replay script generated from `recording1.txt` after smart filtering.
- Generated by: `script-gen --requests-only`
- Contains: 29 user operations (insert, update, delete, find, aggregate, etc.)
- Purpose: Expected output for validation; can be replayed with `mongosh < expected-operations.js`
- Status: **Validated** - Successfully replayed against MongoDB 8.0 replica set

### `generate-test-operations.js`
Comprehensive test script covering all major MongoDB operations.
- Purpose: Run this while recording traffic to generate a comprehensive test recording
- Coverage: 70+ different operation types and variations
- Use for: Creating new recordings with broader test coverage

## Workflow: Recording and Validating

### 1. Start Recording Traffic

```bash
# Start MongoDB with traffic recording
mongosh mongodb://localhost:27017/admin

# In mongosh:
db.runCommand({
  startRecordingTraffic: 1,
  filename: "/Users/frank.snow/go/src/github.com/fsnow/traffic-replay/recordings/recording2.txt",
  bufferSize: 100000000  // 100 MB
})
```

### 2. Generate Test Operations

```bash
# Run comprehensive test operations
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005/traffictest < recordings/generate-test-operations.js
```

### 3. Stop Recording

```bash
# In mongosh:
db.adminCommand({ stopRecordingTraffic: 1 })
```

### 4. Filter and Analyze

```bash
# Filter to user operations only
go run cmd/filter/main.go \
  -input recordings/recording2.txt \
  -output recordings/recording2-filtered.bin \
  -user-ops-smart -requests-only

# Analyze what was captured
go run cmd/analyze-detailed/main.go recordings/recording2-filtered.bin
```

### 5. Generate Replay Script

```bash
# Generate mongosh replay script
go run cmd/script-gen/main.go recordings/recording2-filtered.bin --requests-only \
  > recordings/expected-operations-v2.js
```

### 6. Validate Replay

```bash
# Drop test database
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005/traffictest \
  --eval "db.dropDatabase()"

# Replay operations
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005 \
  < recordings/expected-operations-v2.js

# Verify results
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005/traffictest \
  --eval "db.getCollectionNames().forEach(c => print(c + ':', db[c].countDocuments({})))"
```

### 7. Compare Scripts

If you run `generate-test-operations.js` again while recording, the generated replay script should match (modulo ObjectIds and timestamps).

```bash
# Compare operation types
diff <(grep "^db.getSiblingDB" recordings/expected-operations-v2.js | sed 's/(.*//' | sort | uniq -c) \
     <(grep "^db.getSiblingDB" recordings/expected-operations-v3.js | sed 's/(.*//' | sort | uniq -c)
```

## Test Coverage

### Current Coverage (recording1.txt / expected-operations.js)

**CRUD Operations:**
- ✅ insertMany (batches)
- ✅ insertOne (singles)
- ✅ updateOne (with $set, $push)
- ✅ updateMany (with $set)
- ✅ replaceOne (full document)
- ✅ deleteOne
- ✅ deleteMany
- ✅ find (various filters, with limit)

**Aggregation:**
- ✅ $group, $unwind, $match, $project
- ✅ $avg, $sum

**Index & Collection:**
- ✅ createIndexes
- ✅ listIndexes
- ✅ distinct

### Extended Coverage (generate-test-operations.js)

**Find Options:**
- Projection
- Sort
- Skip
- Complex queries ($or, $and, $in, regex)

**Update Operators:**
- $inc, $mul, $min, $max
- $unset, $rename
- $addToSet, $pull, $pop
- $push with $each, $sort, $slice

**Find and Modify:**
- findOneAndUpdate (returnDocument: before/after)
- findOneAndReplace
- findOneAndDelete

**Count:**
- countDocuments
- estimatedDocumentCount

**Collection Ops:**
- createCollection (with capped options)
- drop
- listCollections

**Index Types:**
- Unique indexes
- Compound indexes
- Partial indexes
- TTL indexes
- Text indexes
- dropIndex, dropIndexes

**Advanced Aggregation:**
- $lookup (joins)
- $bucket, $facet
- $sortByCount, $sample

**Text Search:**
- Text index creation
- $text search queries

**Bulk Operations:**
- bulkWrite with mixed operations

**Admin:**
- listDatabases
- stats (collection and database)

## Filtering Statistics

For typical recordings from a replica set:

```
Full Recording:     5,041 packets (2.2 MiB)
After filtering:       29 packets (11.7 KiB)
Reduction:           99.4%

Removed operations:
  - 155 admin operations (hello, ping, buildInfo)
  - 338 getMore on local.oplog.rs (replication)
  - 4,500+ responses
  - Session/transaction metadata
```

## Script Generation Notes

The script generator automatically:
- Uses `db.getSiblingDB("database")` for explicit database names
- Converts to `insertMany()` for batches, `insertOne()` for singles
- Detects `replaceOne()` vs `updateOne()` based on operators
- Removes internal fields: `$clusterTime`, `$db`, `lsid`, `txnNumber`
- Preserves MongoDB operators: `$set`, `$push`, `$match`, etc.

## See Also

- [`docs/filtering.md`](../docs/filtering.md) - Detailed filtering guide
- [`docs/command-ambiguities.md`](../docs/command-ambiguities.md) - Understanding MongoDB metrics
- [MongoDB Wire Protocol](https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/)
