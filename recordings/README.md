# Traffic Recordings

This directory contains traffic recordings and test scripts for the traffic-replay project.

## Files

### `recording1.txt`
Comprehensive test recording (909 KB, 1,813 packets).
- Created: 2025-11-05
- Contains: 56 user operations + 1,757 internal operations (hello, getMore on oplog, etc.)
- Purpose: Comprehensive validation with 70+ operation types
- Generated from: Running `generate-test-operations.js` while recording

### `expected-operations.js`
Mongosh replay script generated from `recording1.txt` after smart filtering (622 lines).
- Generated by: `script-gen --requests-only`
- Contains: 56 user operations with comprehensive coverage
- Purpose: Expected output for validation; can be replayed with `mongosh < expected-operations.js`
- Status: **Validated** - Successfully replayed against MongoDB 8.0 replica set

### `generate-test-operations.js`
Comprehensive test script covering all major MongoDB operations.
- Purpose: Run this while recording traffic to generate a comprehensive test recording
- Coverage: 70+ different operation types and variations
- Use for: Creating new recordings with broader test coverage

## Workflow: Recording and Validating

### 1. Start Recording Traffic

```bash
# Start MongoDB with traffic recording
# Note: filename must be simple filename (no path), bufferSize must be NumberLong
mongosh mongodb://localhost:28003/admin --quiet --eval "
db.runCommand({
  startRecordingTraffic: 1,
  filename: 'recording2.txt',
  bufferSize: NumberLong('100000000')
})
"

# MongoDB will write to its data directory (e.g., ~/mlaunchdata/test8/recording2.txt)
```

### 2. Generate Test Operations

```bash
# Run comprehensive test operations
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005/traffictest < recordings/generate-test-operations.js
```

### 3. Stop Recording

```bash
# Stop recording
mongosh mongodb://localhost:28003/admin --quiet --eval "
db.adminCommand({ stopRecordingTraffic: 1 })
"

# Copy recording file to project
cp ~/mlaunchdata/test8/recording2.txt recordings/
```

### 4. Filter and Analyze

```bash
# Filter to user operations only
go run cmd/filter/main.go \
  -input recordings/recording2.txt \
  -output recordings/recording2-filtered.bin \
  -user-ops-smart -requests-only

# Analyze what was captured
go run cmd/analyze-detailed/main.go recordings/recording2-filtered.bin
```

### 5. Generate Replay Script

```bash
# Generate mongosh replay script
go run cmd/script-gen/main.go recordings/recording2-filtered.bin --requests-only \
  > recordings/expected-operations-v2.js
```

### 6. Validate Replay

```bash
# Drop test database
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005/traffictest \
  --eval "db.dropDatabase()"

# Replay operations
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005 \
  < recordings/expected-operations-v2.js

# Verify results
mongosh mongodb://localhost:28003,localhost:28004,localhost:28005/traffictest \
  --eval "db.getCollectionNames().forEach(c => print(c + ':', db[c].countDocuments({})))"
```

### 7. Compare Scripts

If you run `generate-test-operations.js` again while recording, the generated replay script should match (modulo ObjectIds and timestamps).

```bash
# Compare operation types
diff <(grep "^db.getSiblingDB" recordings/expected-operations-v2.js | sed 's/(.*//' | sort | uniq -c) \
     <(grep "^db.getSiblingDB" recordings/expected-operations-v3.js | sed 's/(.*//' | sort | uniq -c)
```

## Test Coverage

### Current Coverage (recording1.txt / expected-operations.js - 56 operations)

**Update Operations (11 - 19.6%):**
- ✅ updateOne with $set, $push (basic operators)
- ✅ updateOne with $inc, $mul (numeric operators)
- ✅ updateOne with $min, $max (comparison operators)
- ✅ updateOne with $unset (remove field)
- ✅ updateOne with $rename (rename field)
- ✅ updateOne with $addToSet, $pull, $pop (array operators)
- ✅ updateOne with $push + $each + $sort + $slice (complex array)
- ✅ updateMany with $set
- ✅ replaceOne (full document replacement)

**Find Operations (9 - 16.1%):**
- ✅ find with empty filter, field match, comparison ($lt, $gte)
- ✅ find with projection
- ✅ find with sort
- ✅ find with skip and limit
- ✅ find with complex queries ($or, $and)
- ✅ find with array queries ($in)
- ✅ find with regex

**Aggregation (8 - 14.3%):**
- ✅ Basic stages: $group, $unwind, $match, $project
- ✅ Accumulators: $avg, $sum
- ✅ $lookup (joins between collections)
- ✅ $bucket (grouping by ranges)
- ✅ $facet (multiple parallel pipelines)
- ✅ $sortByCount (group and sort)
- ✅ $sample (random sampling)

**Insert Operations (8 - 14.3%):**
- ✅ insertMany (batches of 3-5 documents)
- ✅ insertOne (single documents)

**Index Operations (5 - 8.9%):**
- ✅ createIndex unique
- ✅ createIndex compound (city, age)
- ✅ createIndex partial (with partialFilterExpression)
- ✅ createIndex TTL (expireAfterSeconds)
- ✅ createIndex text (for text search)
- ✅ dropIndexes (single and all)
- ✅ listIndexes

**Find and Modify (4 - 7.1%):**
- ✅ findOneAndUpdate (returnDocument: before)
- ✅ findOneAndUpdate (returnDocument: after)
- ✅ findOneAndReplace
- ✅ findOneAndDelete

**Collection Operations (4 - 7.1%):**
- ✅ createCollection (capped with size and max)
- ✅ drop collection
- ✅ listCollections

**Other Operations:**
- ✅ count / countDocuments (1)
- ✅ estimatedDocumentCount
- ✅ distinct (with query filter)
- ✅ delete (deleteOne, deleteMany)
- ✅ bulkWrite (mixed operations)
- ✅ Text search ($text operator)
- ✅ Admin: listDatabases, collection stats, database stats

## Filtering Statistics

Current recording (recording1.txt):

```
Full Recording:     1,813 packets (909 KB)
After filtering:       56 packets (21.5 KB)
Reduction:           96.9%

Removed operations:
  - 1,236 responses
  - 521 internal operations (hello, getMore on local.oplog.rs, etc.)
  - Session/transaction metadata ($clusterTime, lsid, txnNumber)
```

The comprehensive test recording is smaller than a typical production recording because:

- Shorter duration (test execution time vs continuous monitoring)
- Fewer concurrent connections (test script vs real application)
- More dense with user operations (70+ operation types executed sequentially)

## Script Generation Notes

The script generator automatically:

- Uses `db.getSiblingDB("database")` for explicit database names
- Converts to `insertMany()` for batches, `insertOne()` for singles
- Detects `replaceOne()` vs `updateOne()` based on operators
- Removes internal fields: `$clusterTime`, `$db`, `lsid`, `txnNumber`
- Preserves MongoDB operators: `$set`, `$push`, `$match`, etc.

## See Also

- [`docs/filtering.md`](../docs/filtering.md) - Detailed filtering guide
- [`docs/command-ambiguities.md`](../docs/command-ambiguities.md) - Understanding MongoDB metrics
- [MongoDB Wire Protocol](https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/)
